layout_conda() {
  local ACTIVATE="${HOME}/miniconda3/bin/activate"

  if [ -n "$1" ]; then
    # Explicit environment name from layout command.
    local env_name="$1"
    source $ACTIVATE ${env_name}
  elif (grep -q name: environment.yml); then
    # Detect environment name from `environment.yml` file in `.envrc` directory
    source $ACTIVATE $(grep name: environment.yml | sed -e 's/name: //' | cut -d "'" -f 2 | cut -d '"' -f 2)
  else
    (echo >&2 No environment specified)
    exit 1
  fi
}

layout_poetry() {
  if [[ ! -f pyproject.toml ]]; then
    log_error 'No pyproject.toml found.  Use `poetry new` or `poetry init` to create one first.'
    exit 2
  fi

  local VENV=$(poetry env info --path)

  # As of <2022-02-04 Fri>:
  #
  # poetry 1.2+ uses a new installer install-poetry.py which always uses the
  # version of Python used to install poetry.
  #
  # In our usage, this would mean that the global version of Python (set by asdf)
  # at the time of Poetry install would get used for all virtualenvs, which is not
  # desirable.
  #
  # See discussion in:
  #
  # - https://github.com/asdf-community/asdf-poetry/issues/10
  # - https://github.com/python-poetry/poetry/pull/4852 (experimental poetry option virtualenvs.prefer-active-python, not yet released at time of writing)
  #
  # To work around this, we force poetry to always use the current asdf-mandated
  # version. If this version doesn't match the current venv version, Poetry will
  # re-create the environment
  #
  #
  poetry env use $(asdf which python)

  if [[ -z $VENV || ! -d $VENV/bin ]]; then
    log_error "No created poetry virtual environment found.  Use 'poetry install' to create one first. (venv=$VENV or $VENV/bin not found)"
    exit 2
  fi
  export VIRTUAL_ENV=$VENV
  export POETRY_ACTIVE=1
  PATH_add "$VENV/bin"

  # # compare $VENV/bin/python to version set in .tool-versions and throw error if
  # # they don't match. Since we do `poetry env use` above, this error will never
  # # get thrown
  # local poetry_python_version=$(python -V | awk '{print $2}')
  # local asdf_python_version=$(asdf current python | awk '{print $2}')
  # if test $poetry_python_version != $asdf_python_version; then
  #   log_error "Poetry Python version: <$poetry_python_version> != asdf Python version: <$asdf_python_version>"
  #   exit 2
  # fi
}
