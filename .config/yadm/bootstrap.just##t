#!/usr/bin/env -S just --justfile
# WARNING: Do not edit this file

set shell := ["bash", "-uc"]
set positional-arguments

default:
    just --list -u -f {{ justfile() }}

@execute_bootstrap *args:
    just --summary --unsorted -f {{ justfile() }} | xargs -n1 echo | rg -vw 'default|execute_bootstrap' | xargs -n1 just -f {{ justfile() }} --verbose "$@"

build_deps:
    sudo apt-get update
    sudo apt-get install build-essential procps curl file git
    sudo apt-get install --no-install-recommends -y \
       make clang\
       libssl-dev zlib1g-dev libbz2-dev \
       libreadline-dev libsqlite3-dev \
       wget llvm \
       libncurses5 libncurses5-dev libncursesw5 \
       xz-utils tk-dev \
       libxml2-dev libffi-dev \
       libxmlsec1-dev liblzma-dev

prezto:
    git clone --recursive https://github.com/sorin-ionescu/prezto.git "${HOME}/.zprezto"
    git clone --recurse-submodules https://github.com/belak/prezto-contrib "${HOME}/.zprezto/contrib"
    cd ~/.zprezto/contrib && git pull

zsh_login_shell:
    sudo apt-get install --no-install-recommends -y zsh && sudo chsh -s $(which zsh) $(whoami)

brew_bundle:
    [ -f ~/.Brewfile ] && { brew bundle --global check || brew bundle --global install -v }

asdf:
    ## https://github.com/asdf-vm/asdf/issues/276#issuecomment-907063520
    cut -d' ' -f1 $HOME/.tool-versions | xargs -i asdf plugin add {}

    ## installs from .tool-versions (which is an alt file)
    ## the install-poetry installer is default with 1.2, but that is still alpha and has bugs <2022-02-07 Mon>
    # ASDF_POETRY_INSTALL_URL=https://install.python-poetry.org asdf install

mambaforge:
    cd /tmp && \
    curl -L -O "https://github.com/conda-forge/miniforge/releases/latest/download/Mambaforge-$(uname)-$(uname -m).sh" && \
    bash Mambaforge.sh -b -p $HOME/.local/mambaforge

pipx:
    # ignoring errors
    -[ -f ~/.pipx.json ] && { cat ~/.pipx.json | jq -r '.venvs[].metadata.main_package.package_or_url' | xargs -n1 pipx install }

git_completion:
    curl -o ${ZSH_CUSTOM_DIR}/git-completion.bash https://raw.githubusercontent.com/git/git/master/contrib/completion/git-completion.bash
    curl -o ${ZSH_CUSTOM_DIR}/_git https://raw.githubusercontent.com/git/git/master/contrib/completion/git-completion.zsh

git_info:
    mkdir -p ~/.local/bin && curl -fsSL https://raw.githubusercontent.com/gitbits/git-info/master/git-info --output ~/.local/bin/git-info && chmod +x ~/.local/bin/git-info

gh_extensions:
    ## Handy way to install things from github
    { gh extension list | grep redraw/gh-install } || gh install redraw/gh-install

git-credential-manager:
    gh release download -p '*.deb' -R GitCredentialManager/git-credential-manager --clobber -D $TEMPDIR && sudo dpkg -i $TEMPDIR/gcm*.deb && git credential-manager configure

misc_utils:
    command -v less || sudo apt-get install --no-install-recommends -y less
    command -v notify-send || sudo apt-get install --no-install-recommends -y libnotify-bin
    command -v svn || sudo apt-get install --no-install-recommends -y subversion # brew installs too many deps
    command -v netstat || sudo apt-get install --no-install-recommends -y net-tools

{% if yadm.class == "personal" %}

chemacs:
    git clone https://github.com/plexus/chemacs.git "${HOME}/.local/chemacs" && $HOME/.local/chemacs/install.sh

doom_emacs:
    git clone https://github.com/hlissner/doom-emacs "${HOME}/.emacs.d" && $HOME/.emacs.d/bin/doom install

_tailscale:
    curl -fsSL https://pkgs.tailscale.com/unstable/ubuntu/jammy.noarmor.gpg | sudo tee /usr/share/keyrings/tailscale-archive-keyring.gpg >/dev/null
    curl -fsSL https://pkgs.tailscale.com/unstable/ubuntu/jammy.tailscale-keyring.list | sudo tee /etc/apt/sources.list.d/tailscale.list
    sudo apt-get update
    sudo apt-get install -y tailscale

tailscale:
    command -v tailscale || just -f {{ justfile() }} _tailscale

leechblock:
    mkdir -p $HOME/dev && cd $HOME/dev && gh repo clone indigoviolet/LeechBlockNG-chrome && cd LeechBlockNG-chrome && ./install-jquery.sh

paywall:
    mkdir -p $HOME/dev && cd $HOME/dev && gh repo clone iamadamdev/bypass-paywalls-chrome

gcloud:
    sudo apt-get install apt-transport-https ca-certificates gnupg
    echo "deb [signed-by=/usr/share/keyrings/cloud.google.gpg] https://packages.cloud.google.com/apt cloud-sdk main" | sudo tee /etc/apt/sources.list.d/google-cloud-sdk.list
    curl https://packages.cloud.google.com/apt/doc/apt-key.gpg | sudo apt-key --keyring /usr/share/keyrings/cloud.google.gpg add -
    sudo apt-get update && sudo apt-get install --no-install-recommends -y google-cloud-sdk

add_matebook_ppas:
    # https://github.com/qu1x/huawei-wmi/tree/master/debian#repository
    echo "deb https://deb.qu1x.org buster main" | sudo tee /etc/apt/sources.list.d/qu1x.list
    # sudo apt-key adv --keyserver hkp://pool.sks-keyservers.net --recv-keys 4503d1ab

    # matebook-applet
    echo "deb [signed-by=/usr/share/keyrings/matebook-applet.key] http://evgenykuznetsov.org/repo/ stable main" | sudo tee /etc/apt/sources.list.d/matebook-applet.list
    wget -qO - https://raw.githubusercontent.com/nekr0z/matebook-applet/master/matebook-applet.key | sudo tee /usr/share/keyrings/matebook-applet.key

nerd_fonts:
    #!/usr/bin/env bash --init-file ${HOME}/.bashrc
    set_init
    # Jetbrains Mono patched (https://github.com/ryanoasis/nerd-fonts#option-5-clone-the-repo)
    if [[ ! -d  $HOME/dev/nerd-fonts ]]; then
        mkdir -p $HOME/dev
        cd $HOME/dev
        git clone --filter=blob:none --sparse git@github.com:ryanoasis/nerd-fonts
    else
        cd $HOME/dev/nerd-fonts
        git fetch
    fi

    for font in JetBrainsMono/Ligatures IBMPlexMono VictorMono Iosevka; do
        git sparse-checkout add patched-fonts/$font
        ./install.sh "${font%%/*}"
    done

doom_all_the_icons:
    # Should we do this via doomscript? https://github.com/doomemacs/doomemacs/issues/6494
    echo 'y' | emacs -l ~/.config/doom/init.el --batch -f all-the-icons-install-fonts

twemoji_fonts:
    sudo apt-add-repository -y -S "deb https://ppa.launchpadcontent.net/eosrei/fonts/ubuntu/ impish main"
    sudo apt-get update
    sudo apt-get install -y fonts-twemoji-svginot

{% endif %}
